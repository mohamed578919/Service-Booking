<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
 <style>
  /* Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØµÙˆØ±Ø© */
  :root{
    --bg:#eef2f7;            /* Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
    --surface:#ffffff;       /* Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ±ÙˆØª/Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ/Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    --sidebar-bg:#ffffff;    /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù€ Sidebar */
    --text:#111827;          /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    --muted:#6b7280;         /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
    --primary:#0d6efd;       /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
    --primary-600:#0b5ed7;   /* Ø£ØºÙ…Ù‚ Ù„Ù„Ù‡ÙˆÙØ± */
    --ring:#eaf2ff;          /* Ø®Ù„ÙÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    --ring-border:#cfe2ff;   /* Ø­Ø§ÙØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± */
    --border:#e5e7eb;        /* Ø­Ø¯ÙˆØ¯ Ø®ÙÙŠÙØ© */
    --shadow:0 4px 10px rgba(0,0,0,.06);
    --danger:#dc3545;
    --success:#28a745;
  }

  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:'Segoe UI',Tahoma,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
  }

  /* Sidebar */
  aside{
    width:240px;
    background:var(--sidebar-bg);
    padding:1rem;
    box-shadow:2px 0 5px rgba(0,0,0,.05);
  }
  aside h2{
    text-align:center;
    font-size:1.1rem;
    margin-bottom:1.5rem;
  }
  aside nav a{
    display:block;
    padding:.75rem 1rem;
    margin-bottom:.5rem;
    text-decoration:none;
    color:#334155;                 /* Ù†Øµ ØºØ§Ù…Ù‚ ÙˆØ§Ø¶Ø­ */
    border-radius:10px;
    border:1px solid transparent;  /* Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ØªØ£Ø«ÙŠØ± ÙŠØ¨Ù‚Ù‰ Ù†Ø§Ø¹Ù… */
    transition:.2s ease;
  }
  aside nav a:hover,
  aside nav a.active{
    background:var(--ring);
    color:var(--primary);
    border-color:var(--ring-border);
  }

  /* Main layout */
  .main-wrapper{flex:1;display:flex;flex-direction:column}

  /* Topbar */
  header{
    background:var(--surface);
    padding:1rem 2rem;
    display:flex;justify-content:space-between;align-items:center;
    border-bottom:1px solid var(--border);
  }
  .profile-box{display:flex;align-items:center;gap:1rem}
  .avatar{
    width:40px;height:40px;border-radius:50%;
    background:var(--primary);color:#fff;font-weight:700;
    display:flex;align-items:center;justify-content:center;
  }

  /* Buttons */
  .btn{
    padding:.5rem 1rem;border:none;border-radius:10px;cursor:pointer
  }
  .btn.primary{background:var(--primary);color:#fff}
  .btn.primary:hover{background:var(--primary-600)}
  .btn.danger{background:var(--danger);color:#fff}

  /* Content */
  main{flex:1; padding:2rem; overflow:auto}
  .card{
    background:var(--surface);
    padding:1.25rem 1.5rem;
    border-radius:14px;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
    margin-bottom:1.5rem;
  }

  /* Table */
  table{width:100%;border-collapse:collapse}
  th,td{padding:.75rem;text-align:right;border-bottom:1px solid var(--border)}
  th{background:#f8fafc;color:#111827;font-weight:600}
  td button{
    background:var(--primary);color:#fff;border:none;
    padding:.4rem .8rem;border-radius:8px;cursor:pointer
  }
  td button:hover{background:var(--primary-600)}

  /* Modals */
  .modal{
    display:none;position:fixed;inset:0;
    background:rgba(0,0,0,.45);align-items:center;justify-content:center
  }
  .modal.show{display:flex}
  .modal-content{
    background:var(--surface);padding:1.25rem;border-radius:14px;width:420px;
    box-shadow:var(--shadow);border:1px solid var(--border)
  }
  .modal-content label{display:block;margin:.5rem 0;color:#1f2937}
  .modal-content input,
  .modal-content textarea,
  .modal-content select{
    width:100%;padding:.6rem;border:1px solid var(--border);
    border-radius:10px;margin-top:.35rem;background:#fff
  }

  /* Toasts */
  .toast{
    position:fixed;top:20px;right:20px;z-index:1000;
    padding:14px 22px;border-radius:10px;color:#fff;
    opacity:0;transform:translateY(-12px);transition:.25s
  }
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{background:var(--success)}
  .toast.error{background:var(--danger)}
  .btn.disabled {
  background: #9ca3af !important; /* Ø±Ù…Ø§Ø¯ÙŠ */
  cursor: not-allowed;
  pointer-events: none;
}

</style>

</head>
<body>

  <!-- Sidebar -->
  <aside>
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <nav>
      <a href="#home" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="#requests">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
      <a href="#applications">Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¹Ù„ÙŠÙ‡Ø§</a>
      <a href="#profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </nav>
  </aside>

  <!-- Main wrapper -->
  <div class="main-wrapper">
    <!-- Topbar -->
    <header>
      <div class="profile-box">
        <div id="avatar" class="avatar">A</div>
        <span id="profileNameShort">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
      </div>
      <div>
        <button id="openCreateBtn" class="btn primary">+ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        <button id="logoutBtn" class="btn danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Content -->
    <main id="mainContent">
      <div class="card">
        <h3>Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ğŸ‘‹</h3>
        <p>Ù‡Ù†Ø§ Ø³ÙŠÙƒÙˆÙ† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</p>
      </div>
    </main>
  </div>

  <!-- Modals (Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„) -->
  <div class="modal" id="createModal">
    <div class="modal-content">
      <h3>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="createForm">
        <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:
          <select id="c_service" required>
            <option value="">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø©</option>
          </select>
        </label>
        <label>Ø§Ù„ÙˆØµÙ:
          <textarea id="c_description" required></textarea>
        </label>
        <button type="submit" class="btn primary">Ø­ÙØ¸</button>
        <button type="button" class="btn" onclick="closeModal('createModal')">Ø¥Ù„ØºØ§Ø¡</button>
      </form>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨</h3>
      <form id="editForm">
        <input type="hidden" id="e_id" />
        <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:
          <select id="e_service" required>
            <option value="">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø©</option>
          </select>
        </label>
        <label>Ø§Ù„ÙˆØµÙ:
          <textarea id="e_description" required></textarea>
        </label>
        <button type="submit" class="btn primary">Ø­ÙØ¸</button>
        <button type="button" class="btn" onclick="closeModal('editModal')">Ø¥Ù„ØºØ§Ø¡</button>
      </form>
    </div>
  </div>
  <div id="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;"></div>

<!-- PayPal container -->
<div id="paypal-container" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:1rem;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:1000;">
  <div id="paypal-button-container"></div>
  <button onclick="closePayPal()" class="btn" style="margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

  <!-- JS -->
   <script>
    const API_BASE = "https://localhost:7137/api";
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "login.html";
    }

    const headersAuth = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };

    function parseJwt(token) {
      try {
        if (!token || typeof token !== "string" || token.split('.').length !== 3) {
          throw new Error("Invalid JWT token format");
        }
        const base64 = token.split('.')[1].replace('-', '+').replace('_', '/');
        const decoded = JSON.parse(atob(base64));
        if (!decoded || typeof decoded !== "object") {
          throw new Error("Invalid JWT payload");
        }
        return decoded;
      } catch (e) {
        console.error("Failed to parse JWT:", e.message);
        return null;
      }
    }

    async function loadServices(selectId) {
      try {
        const res = await fetch(`${API_BASE}/Service/GetServiceNames`, { headers: headersAuth });
        if (!res.ok) {
          throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª: ${res.status} ${res.statusText}`);
        }
        const services = await res.json();
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø©</option>';
        services.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
      } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª:", e.message);
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.", "error");
        const select = document.getElementById(selectId);
        select.outerHTML = `<input type="text" id="${selectId}" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" />`;
      }
    }

    async function loadProfile() {
      const decoded = parseJwt(token);
      if (!decoded) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
        return;
      }
      const userName = decoded["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] || "Zekry";
      const res = await fetch(`${API_BASE}/Client/me?ClientUserNamed=${encodeURIComponent(userName)}`, { headers: headersAuth });
      if (res.ok) {
        const profile = await res.json();
        document.getElementById("profileNameShort").textContent = `${profile.fullName.split(" ")[0][0]}. ${profile.fullName}`;
        document.getElementById("avatar").textContent = profile.fullName.split(" ")[0][0];
        window.clientProfile = profile;
        router();
      } else {
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„:", await res.text());
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }
    }

    function openModal(id) { document.getElementById(id).classList.add("show"); }
    function closeModal(id) { document.getElementById(id).classList.remove("show"); }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ³Øª
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙˆØ³Øª
      setTimeout(() => toast.classList.add("show"), 100);

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙˆØ³Øª Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300); // Ø¥Ø²Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­ÙˆÙŠÙ„
      }, 3000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      });
      document.getElementById("openCreateBtn").addEventListener("click", () => {
        openModal("createModal");
      });
      loadServices("c_service");
      loadServices("e_service");
      loadProfile();
    });

    async function router() {
  const hash = location.hash || "#home";

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ active ÙÙŠ Ø§Ù„Ù€ sidebar
  document.querySelectorAll("aside nav a").forEach(a => {
    if (a.getAttribute("href") === hash) {
      a.classList.add("active");
    } else {
      a.classList.remove("active");
    }
  });

  if (hash === "#home") renderHome();
  else if (hash === "#requests") await renderRequests();
  else if (hash === "#applications") await renderApplications();
  else if (hash === "#profile") renderProfile();
}


    function renderHome() {
      const p = window.clientProfile || {};
      document.getElementById("mainContent").innerHTML = `
        <div class="card">
          <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ ${p.fullName || "-"} ğŸ‘‹</h2>
          <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${p.email || "-"}</p>
          <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${p.phone || "-"}</p>
        </div>`;
    }

    async function renderRequests() {
      const decoded = parseJwt(token);
      if (!decoded) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
        return;
      }
      const userName = decoded["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] || "Zekry";
      const res = await fetch(`${API_BASE}/Request/${encodeURIComponent(userName)}`, { headers: headersAuth });
      if (res.ok) {
        const requests = await res.json();
        console.log("Requests data:", JSON.stringify(requests, null, 2));
        if (requests.length === 0) {
          document.getElementById("mainContent").innerHTML = `
            <div class="card">
              <h2>Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
              <p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</p>
            </div>`;
        } else {
          document.getElementById("mainContent").innerHTML = `
            <div class="card">
              <h2>Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
              <table>
                <thead>
                  <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„ÙˆØµÙ</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                  </tr>
                </thead>
                <tbody>
                  ${requests.map(r => `
                    <tr>
                      <td>${r.category || '-'}</td>
                      <td>${new Date(r.createdAt).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                      <td>${r.description || '-'}</td>
                      <td><button onclick="editRequest(${r.id})">ØªØ¹Ø¯ÙŠÙ„</button></td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>
            </div>`;
        }
      } else {
        document.getElementById("mainContent").innerHTML = `
          <div class="card">
            <h2>Ø®Ø·Ø£</h2>
            <p class="empty-message">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
          </div>`;
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", await res.text());
      }
    }

    document.getElementById("createForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const decoded = parseJwt(token);
      if (!decoded) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
        return;
      }
      const userName = decoded["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] || "Zekry";
      const data = {
        ClientUserNamed: userName,
        Title: document.getElementById("c_service").value,
        Description: document.getElementById("c_description").value,
        Service: document.getElementById("c_service").value,
        Budget: 0
      };
      const res = await fetch(`${API_BASE}/Request/Create`, { 
        method: "POST", 
        headers: headersAuth, 
        body: JSON.stringify(data) 
      });
      if (res.ok) { 
        closeModal("createModal"); 
        await renderRequests(); 
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", "success"); 
      } else {
        console.error("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨:", await res.text());
        showToast("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø®Ø¯Ù…Ø© ØµØ§Ù„Ø­Ø©.", "error");
      }
    });

    async function editRequest(id) {
      if (!id || isNaN(id)) {
        console.error("Invalid request ID:", id);
        showToast("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­.", "error");
        return;
      }
      const res = await fetch(`${API_BASE}/Request/${id}`, { headers: headersAuth });
      if (res.ok) {
        const request = await res.json();
        document.getElementById("e_id").value = request.id;
        const select = document.getElementById("e_service");
        if (select.tagName === "SELECT") {
          select.value = request.category || request.title;
        } else {
          select.value = request.category || request.title;
        }
        document.getElementById("e_description").value = request.description;
        openModal("editModal");
      } else {
        const errorText = await res.text();
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:", errorText);
        showToast(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: ${errorText || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`, "error");
      }
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const decoded = parseJwt(token);
      if (!decoded) {
        localStorage.removeItem("token");
        window.location.href = "login.html";
        return;
      }
      const id = document.getElementById("e_id").value;
      const userName = decoded["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"] || "fahd20";
      const data = {
        ClientUserNamed: userName,
        Title: document.getElementById("e_service").value,
        Description: document.getElementById("e_description").value,
        Service: document.getElementById("e_service").value,
        Budget: 0
      };
      const res = await fetch(`${API_BASE}/Request/${id}`, { 
        method: "PUT", 
        headers: headersAuth, 
        body: JSON.stringify(data) 
      });
      if (res.ok) { 
        closeModal("editModal"); 
        await renderRequests(); 
        showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", "success"); 
      } else {
        console.error("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", await res.text());
        showToast("ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø®Ø¯Ù…Ø© ØµØ§Ù„Ø­Ø©.", "error");
      }
    });

    // ----------- Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -----------
   function renderProfile() {
  const p = window.clientProfile || {};
  document.getElementById("mainContent").innerHTML = `
    <div class="card">
      <h2 style="margin-bottom:1rem;">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h2>
      <div style="display:grid;gap:1rem;">
        
        <div style="display:flex;align-items:center;gap:.75rem;">
          <span style="font-size:1.2rem; color:var(--primary);">ğŸ‘¤</span>
          <div>
            <div style="font-weight:600; color:var(--muted);">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
            <div style="font-size:1rem;">${p.fullName || "-"}</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:.75rem;">
          <span style="font-size:1.2rem; color:var(--primary);">ğŸ“§</span>
          <div>
            <div style="font-weight:600; color:var(--muted);">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
            <div style="font-size:1rem;">${p.email || "-"}</div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:.75rem;">
          <span style="font-size:1.2rem; color:var(--primary);">ğŸ“±</span>
          <div>
            <div style="font-weight:600; color:var(--muted);">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
            <div style="font-size:1rem;">${p.phone || "-"}</div>
          </div>
        </div>

      </div>
    </div>`;
}

async function renderApplications() {
  const decoded = parseJwt(token);
  if (!decoded) {
    localStorage.removeItem("token");
    window.location.href = "login.html";
    return;
  }
  const userName = decoded["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"];

  try {
    const res = await fetch(`${API_BASE}/Request/Applications/${encodeURIComponent(userName)}`, { headers: headersAuth });
    if (!res.ok) throw new Error(await res.text());

    const applications = await res.json();
    if (applications.length === 0) {
      document.getElementById("mainContent").innerHTML = `
        <div class="card">
          <h2>Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¹Ù„ÙŠÙ‡Ø§</h2>
          <p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>
        </div>`;
    } else {
      document.getElementById("mainContent").innerHTML = `
        <div class="card">
          <h2>Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¹Ù„ÙŠÙ‡Ø§</h2>
          <table>
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø²ÙˆØ¯</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø·Ù„Ø¨</th>
                <th>Ø§Ù„Ø¯ÙØ¹</th>
                <th>ØªÙˆØ§ØµÙ„</th> <!-- Ø¹Ù…ÙˆØ¯ Ø¬Ø¯ÙŠØ¯ -->
              </tr>
            </thead>
            <tbody>
              ${applications.map(a => {
                const phone = a.phoneNumber ? a.phoneNumber.replace(/\D/g,'') : "";
                const waLink = phone ? `https://wa.me/${phone}` : "#";
                return `
                  <tr>
                    <td>${a.providerName}</td>
                    <td>${a.phoneNumber || "-"}</td>
                    <td>${a.message || "-"}</td>
                    <td>${a.requestTitle}</td>
                    
                      <td>
  <button class="btn primary" onclick="openPayPal(this)">Ø§Ø¯ÙØ¹ Ø§Ù„Ø§Ù†</button>
</td>

                    </td>
                    <td>
                      ${phone ? `<a href="${waLink}" target="_blank" class="btn primary disabled" id="wa-${a.id}">ÙˆØ§ØªØ³Ø§Ø¨</a>` : "-"}

                    </td>
                  </tr>`;
              }).join("")}
            </tbody>
          </table>
        </div>`;
    }
  } catch (err) {
    console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶:", err.message);
    document.getElementById("mainContent").innerHTML = `
      <div class="card">
        <h2>Ø®Ø·Ø£</h2>
        <p>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±ÙˆØ¶. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
      </div>`;
  }
}


    window.addEventListener("hashchange", router);
    ///////////////////////////////
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ div
   function openPayPal(button) {
  document.getElementById("paypal-container").style.display = "block";
  document.getElementById("overlay").style.display = "block";

  // Ù†Ø®Ø²Ù† Ø§Ù„Ù€ row Ø£Ùˆ application ID
  const row = button.closest("tr");
  const waBtn = row.querySelector("a.btn");

  const amount = '20.00';

  paypal.Buttons({
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{ amount: { value: amount } }]
      });
    },
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        showToast(`âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¨ÙˆØ§Ø³Ø·Ø©: ${details.payer.name.given_name}`, "success");
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨
        if (true) waBtn.classList.remove("disabled");
        closePayPal();
      });
    },
    onError: function(err) {
      console.error(err);
      showToast("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹", "error");
      closePayPal();
    }
  }).render('#paypal-button-container');
}

function closePayPal() {
  const container = document.getElementById("paypal-container");
  const overlay = document.getElementById("overlay");
  if(container) container.style.display = "none";
  if(overlay) overlay.style.display = "none";
}

  </script>
  <script src="https://www.paypal.com/sdk/js?client-id=ARq8EGfg10WyGEjVGliMZvYiwu9kHPPBy5k9ORGRwBFAWyMeJYtrb3eJrnvg8ksoXssmLnrIYC2-zzGt&currency=USD&components=buttons"></script>

</body>
</html>  