<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة تحكم المزود</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#333;
      --muted:#7a7a7a;
      --primary:#0A66C2;
      --primary-600:#0959a9;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:0;font-family:Tahoma, Arial, sans-serif;background:var(--bg);color:var(--text)}
    .header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 16px;}
    .app-title{margin:0;font-size:18px;color:var(--primary)}
    .btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:6px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:16px;padding:16px}
    .sidebar{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;height:calc(100vh - 70px);position:sticky;top:70px;overflow:auto}
    .profile-card{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .avatar{width:48px;height:48px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;}
    .profile-name{font-weight:bold}
    .profile-sub{font-size:12px;color:var(--muted)}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav-link{display:block;padding:10px;border-radius:10px;text-decoration:none;color:var(--text)}
    .nav-link.active{background:#e9f2ff;color:var(--primary)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card-title{margin:0 0 12px 0;color:var(--primary);font-size:18px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid var(--border);padding:8px;text-align:center}
    .table th{background:#f0f5ff}
    .empty{text-align:center;color:var(--muted);margin-top:10px}
    .toast{position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s;transform:translateY(10px);}
    .toast.show{opacity:1;transform:translateY(0)}
    .search-box{margin-bottom:12px;}
    .search-input{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;}
    .apps{margin-top:15px;}
    .app{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .app strong{color:var(--primary);}
    textarea,input{padding:6px;border-radius:6px;border:1px solid #ccc;margin-bottom:6px;}
  </style>
</head>
<body>

<header class="header">
  <h1 class="app-title">لوحة تحكم المزود</h1>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="profile-card">
      <div class="avatar" id="avatar">؟</div>
      <div>
        <div class="profile-name" id="profileName">جارِ التحميل…</div>
        <div class="profile-sub">مزود خدمة</div>
      </div>
    </div>
   <nav class="nav">
  <a href="#home" class="nav-link active">الرئيسية</a>
  <a href="#jobs" class="nav-link">الوظائف المتاحة</a>
  <a href="#applied" class="nav-link">وظائفي المتقدم لها</a>
  <a href="#requestDetails" class="nav-link">تفاصيل الطلب</a>
  <a href="#profile" class="nav-link">معلوماتي</a>
  <hr>
  <a href="login.html" class="nav-link">تسجيل الدخول</a>
  <a href="REGISTER.HTML" class="nav-link">تسجيل جديد</a>
  <a href="login.html" class="nav-link" id="logoutLink">تسجيل الخروج</a>
</nav>

  </aside>

  <main class="main" id="mainContent"></main>
</div>

<div id="toast" class="toast"></div>

<script type="module">
const API_BASE = "https://localhost:7137/api";

// helper
function getAuthHeaders() {
  return {
    "accept": "application/json",
    "Authorization": `Bearer ${localStorage.getItem("token")}`
  };
}

async function getAllRequests() {
  const res = await fetch(`${API_BASE}/Request/All`, { headers: getAuthHeaders() });
  if (!res.ok) throw new Error("فشل تحميل الوظائف");
  return res.json();
}

async function getRequestById(id) {
  const res = await fetch(`${API_BASE}/Request/${id}`, { headers: getAuthHeaders() });
  if (!res.ok) throw new Error("لم يتم العثور على الوظيفة");
  return res.json();
}

async function getProfile() {
  const res = await fetch(`${API_BASE}/Account/profile`, { headers: getAuthHeaders() });
  if (!res.ok) throw new Error("فشل تحميل بيانات المزود");
  return res.json();
}

// UI Logic
let appliedJobs = []; 
let allJobs = []; 

const main = document.getElementById("mainContent");
const profileNameEl = document.getElementById("profileName");
const avatarEl = document.getElementById("avatar");
const toastEl = document.getElementById("toast");
const navLinks = document.querySelectorAll(".nav-link");

function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"),2500);
}
function setActive(hash){navLinks.forEach(a=>a.classList.toggle("active",a.getAttribute("href")===hash));}
function getInitials(name=""){const p=name.trim().split(" ");return (p[0]?.[0]||"")+(p[1]?.[0]||"");}

async function loadProvider(){
  try {
    const data = await getProfile();
    const name = data.fullName || data.userName || "مزود";
    profileNameEl.textContent = name;
    avatarEl.textContent = getInitials(name);
    localStorage.setItem("username", data.userName || "provider");
  } catch (err) {
    console.error(err);
    profileNameEl.textContent = "خطأ في التحميل";
    avatarEl.textContent = "؟";
  }
}

async function renderHome(){
  main.innerHTML=`<section class="card">
      <h2 class="card-title">مرحباً ${profileNameEl.textContent} 👋</h2>
      <p>من هنا يمكنك استعراض الوظائف والتقديم عليها.</p>
    </section>`;
}

async function renderJobs(){
  main.innerHTML=`<section class="card">
      <h2 class="card-title">الوظائف المتاحة</h2>
      <div class="search-box">
        <input id="jobSearch" type="text" placeholder="🔍 ابحث عن وظيفة..." class="search-input"/>
      </div>
      <table class="table"><thead>
        <tr><th>#</th><th>العنوان</th><th>الوصف</th><th>التصنيف</th><th>الميزانية</th><th>العميل</th><th>التاريخ</th><th></th></tr>
      </thead><tbody id="jobsBody"></tbody></table>
      <p id="noJobs" class="empty" style="display:none">لا توجد وظائف حالياً</p>
    </section>`;

  try{
    allJobs = await getAllRequests();
    displayJobs(allJobs);

    document.getElementById("jobSearch").addEventListener("input", e=>{
      const q = e.target.value.trim().toLowerCase();
      if(q===""){ displayJobs(allJobs); return; }
      const filtered = allJobs.filter(j=>
        j.title.toLowerCase().includes(q) ||
        (j.description||"").toLowerCase().includes(q) ||
        (j.clientName||"").toLowerCase().includes(q)
      );
      displayJobs(filtered);
    });

  }catch(err){
    console.error(err);
    showToast("خطأ في تحميل الوظائف");
  }
}

function displayJobs(jobs){
  const body=document.getElementById("jobsBody");
  if(jobs.length===0){document.getElementById("noJobs").style.display="block";body.innerHTML="";return;}
  document.getElementById("noJobs").style.display="none";
  body.innerHTML="";
  jobs.forEach((j,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${j.title}</td>
      <td>${j.description||"-"}</td>
      <td>${j.category||"-"}</td>
      <td>${j.budget||"-"}</td>
      <td>${j.clientName||"-"}</td>
      <td>${new Date(j.createdAt).toLocaleDateString("ar-EG")}</td>
      <td><button class="btn primary" onclick="applyJob(${j.id})">تقديم</button></td>`;
    body.appendChild(tr);
  });
}

async function renderApplied(){
  main.innerHTML=`<section class="card">
      <h2 class="card-title">وظائفي المتقدم لها</h2>
      <table class="table"><thead>
        <tr><th>#</th><th>العنوان</th><th>الوصف</th><th>التصنيف</th><th>الميزانية</th><th>العميل</th><th>التاريخ</th></tr>
      </thead><tbody id="appliedBody"></tbody></table>
      <p id="noApps" class="empty" style="display:none">لم تتقدم لأي وظيفة بعد</p>
    </section>`;

  const body=document.getElementById("appliedBody");
  if(appliedJobs.length===0){document.getElementById("noApps").style.display="block";return;}
  appliedJobs.forEach((a,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${a.title}</td>
      <td>${a.description||"-"}</td>
      <td>${a.category||"-"}</td>
      <td>${a.budget||"-"}</td>
      <td>${a.clientName||"-"}</td>
      <td>${new Date(a.createdAt).toLocaleDateString("ar-EG")}</td>`;
    body.appendChild(tr);
  });
}

window.applyJob = async function(id){
  try{
    const job = await getRequestById(id);
    appliedJobs.push(job);
    showToast("تم التقديم بنجاح");
    location.hash = `#requestDetails/${id}`;
    renderRequestDetails(id);
  }catch(err){
    console.error(err);
    showToast("فشل التقديم");
  }
}

async function renderRequestDetails(requestId = 1){
  main.innerHTML = `<section class="card">
      <h2 class="card-title">تفاصيل الطلب</h2>
      <div id="requestDetailsBox">جارِ التحميل...</div>
    </section>`;

  try {
    const res = await fetch(`${API_BASE}/Request/${requestId}`, { headers: getAuthHeaders() });
    if(!res.ok) throw new Error("فشل تحميل تفاصيل الطلب");
    const data = await res.json();

    document.getElementById("requestDetailsBox").innerHTML = `
      <h3>${data.title}</h3>
      <p><strong>الوصف:</strong> ${data.description||"-"}</p>
      <p><strong>الفئة:</strong> ${data.category||"-"}</p>
      <p><strong>الميزانية:</strong> ${data.budget||"-"} ج.م</p>
      <p class="muted">بواسطة: ${data.clientName||"-"} - ${new Date(data.createdAt).toLocaleDateString("ar-EG")}</p>

      <div class="apps">
        <h4>العروض المقدمة:</h4>
        ${
          data.applications && data.applications.length > 0
          ? data.applications.map(app=>`
              <div class="app">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                  <strong style="color:var(--primary);font-size:15px;">${app.providerName||"-"}</strong>
                  <span style="font-size:12px;color:var(--muted);">
                    ${app.createdAt && app.createdAt !== "0001-01-01T00:00:00" ? new Date(app.createdAt).toLocaleDateString("ar-EG") : "-"}
                  </span>
                </div>
                <p style="margin:6px 0;"><strong>✦ العرض:</strong> ${app.message||"-"}</p>
                <p><strong>📞 الهاتف:</strong> ${app.phoneNumber||"-"}</p>
                ${app.note ? `<p><strong>📝 ملاحظات:</strong> ${app.note}</p>` : ""}
              </div>
            `).join("")
          : "<p class='empty'>لا يوجد عروض حتى الآن</p>"
        }
      </div>

      <hr>
      <h4>تقديم عرض جديد</h4>
      <form id="proposalForm">
        <textarea id="proposalText" placeholder="نص العرض" required style="width:100%;"></textarea>
        <input type="number" id="proposedPrice" placeholder="السعر المقترح" required style="width:100%;" />
        <input type="text" id="proposalPhone" placeholder="رقم الهاتف" required style="width:100%;" />
        <input type="text" id="proposalNote" placeholder="ملاحظات إضافية" style="width:100%;" />
        <button type="submit" class="btn primary" style="margin-top:8px;">إرسال العرض</button>
      </form>
    `;

    document.getElementById("proposalForm").addEventListener("submit", async function(e){
      e.preventDefault();
      try{
        const dto = {
          providerUserName: localStorage.getItem("username"),
          proposalText: document.getElementById("proposalText").value,
          proposedPrice: parseFloat(document.getElementById("proposedPrice").value),
          phoneNumber: document.getElementById("proposalPhone").value,
          note: document.getElementById("proposalNote").value,
          serviceRequestId: requestId
        };

        const res = await fetch(`${API_BASE}/Applications/Create`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}`
          },
          body: JSON.stringify(dto)
        });

        if(!res.ok){
          const errText = await res.text();
          throw new Error("فشل إرسال العرض: " + errText);
        }
        await res.json();
        showToast("تم تقديم العرض بنجاح!");
        renderRequestDetails(requestId);
      } catch(err){
        console.error(err);
        showToast(err.message);
      }
    });

  } catch(err){
    document.getElementById("requestDetailsBox").innerHTML = `<p>خطأ: ${err.message}</p>`;
  }
}

async function renderProfile(){
  main.innerHTML = `<section class="card">
      <h2 class="card-title">معلومات المزود</h2>
      <div id="profileBox">جارِ التحميل...</div>
    </section>`;

  try {
    const data = await getProfile();
    document.getElementById("profileBox").innerHTML = `
      <p><strong>الاسم:</strong> ${data.fullName || data.userName || "-"}</p>
      <p><strong>البريد الإلكتروني:</strong> ${data.email || "-"}</p>
      <p><strong>رقم الهاتف:</strong> ${data.phoneNumber || "-"}</p>
      <p><strong>الدور:</strong> ${data.role || "مزود خدمة"}</p>
    `;
  } catch(err) {
    document.getElementById("profileBox").innerHTML = `<p>خطأ: ${err.message}</p>`;
  }
}

async function router(){
  const hash=location.hash||"#home";setActive(hash.split("/")[0]);
  const parts = hash.split("/");
  if(parts[0]==="#home") renderHome();
  else if(parts[0]==="#jobs") renderJobs();
  else if(parts[0]==="#applied") renderApplied();
  else if(parts[0]==="#requestDetails") renderRequestDetails(parts[1]?parseInt(parts[1]):1);
  else if(parts[0]==="#profile") renderProfile();
  else renderHome();
}
window.addEventListener("hashchange",router);

(async function init(){
  await loadProvider();
  router();
})();
</script>

</body>
</html>
